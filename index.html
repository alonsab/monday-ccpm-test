<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCPM Board Viewer</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { 
            background: linear-gradient(135deg, #0073ea, #6200ea);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: center;
        }
        .status-card { 
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e1e5e9;
        }
        .success { color: #00ca72; font-weight: 600; }
        .error { color: #e2445c; font-weight: 600; }
        .warning { color: #fdab3d; font-weight: 600; }
        .info { color: #0073ea; font-weight: 600; }
        .board-info { 
            background: #f6f7fb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .task-grid {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }
        .task-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 16px;
            transition: box-shadow 0.2s;
        }
        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .task-title { font-weight: 600; margin-bottom: 8px; }
        .task-details { font-size: 14px; color: #676879; }
        .debug-log { 
            background: #1e1e1e;
            color: #00ff41;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #0073ea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 4px;
            transition: background 0.2s;
        }
        button:hover { background: #005bb5; }
        .button-secondary { background: #676879; }
        .button-secondary:hover { background: #5a5a6b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ CCPM Board Viewer</h1>
            <p>Critical Chain Project Management for Monday.com</p>
        </div>

        <div class="status-card">
            <h2>üìä Connection Status</h2>
            <div id="status">Initializing connection...</div>
            <div style="margin-top: 16px;">
                <button onclick="runTest()">üîÑ Refresh Data</button>
                <button onclick="clearLog()" class="button-secondary">üóëÔ∏è Clear Log</button>
            </div>
        </div>

        <div id="boardSection" class="status-card" style="display: none;">
            <h2>üìã Board Information</h2>
            <div id="boardInfo" class="board-info"></div>
            <div id="taskContainer"></div>
        </div>

        <div class="status-card">
            <h2>üêõ Debug Information</h2>
            <div id="debugLog" class="debug-log">Starting CCPM Board Viewer...\n</div>
        </div>
    </div>

    <script>
        // Safe logging that won't cause iframe issues
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('debugLog');
            if (logEl) {
                logEl.textContent += `[${timestamp}] ${message}\n`;
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            // Try console.log safely
            try {
                if (typeof console !== 'undefined' && console.log) {
                    console.log(`[CCPM] ${message}`);
                }
            } catch (e) {
                // Ignore console errors in iframe
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                const className = type === 'success' ? 'success' : 
                               type === 'error' ? 'error' : 
                               type === 'warning' ? 'warning' : 'info';
                statusEl.innerHTML = `<span class="${className}">${message}</span>`;
            }
            log(message, type);
        }

        function clearLog() {
            const logEl = document.getElementById('debugLog');
            if (logEl) {
                logEl.textContent = 'Log cleared.\n';
            }
        }

        // Global Monday.com SDK reference
        let monday = null;

        // Extract data from URL parameters (since we have the board context)
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                boardId: urlParams.get('boardId'),
                sessionToken: urlParams.get('sessionToken'),
                userId: urlParams.get('userId'),
                accountId: urlParams.get('accountId'),
                instanceId: urlParams.get('instanceId')
            };
        }

        async function runTest() {
            log('=== CCPM CONNECTION TEST STARTED ===');
            
            try {
                // Step 1: Check URL parameters
                const params = getUrlParams();
                log(`Board ID from URL: ${params.boardId}`);
                log(`Session Token: ${params.sessionToken ? 'Present' : 'Missing'}`);
                log(`Running in iframe: ${window !== window.top}`);
                
                if (params.boardId) {
                    updateStatus(`‚úÖ Board context detected: ${params.boardId}`, 'success');
                } else {
                    updateStatus('‚ö†Ô∏è No board ID in URL parameters', 'warning');
                }

                // Step 2: Try to access Monday SDK
                log('Checking for Monday SDK...');
                
                // Check multiple possible ways Monday SDK might be available
                const sdkSources = [
                    () => window.mondaySDK,
                    () => window.monday,
                    () => parent.mondaySDK,
                    () => parent.monday
                ];

                let sdkFound = false;
                for (let i = 0; i < sdkSources.length; i++) {
                    try {
                        const sdk = sdkSources[i]();
                        if (sdk && typeof sdk === 'function') {
                            monday = sdk();
                            log(`‚úÖ Monday SDK found via method ${i + 1}`);
                            updateStatus('‚úÖ Monday SDK initialized', 'success');
                            sdkFound = true;
                            break;
                        }
                    } catch (e) {
                        log(`SDK check method ${i + 1} failed: ${e.message}`);
                    }
                }

                if (!sdkFound) {
                    log('‚ùå Monday SDK not found in any location');
                    updateStatus('‚ùå Monday SDK not available', 'error');
                    
                    // Even without SDK, we can show the board context from URL
                    if (params.boardId) {
                        showBoardContext(params);
                    }
                    return;
                }

                // Step 3: Try to get context from SDK
                log('Getting context from Monday SDK...');
                try {
                    const context = await monday.get("context");
                    log(`Context received: ${JSON.stringify(context, null, 2)}`);
                    
                    if (context && context.data && context.data.boardId) {
                        updateStatus(`‚úÖ Connected to Monday.com board: ${context.data.boardId}`, 'success');
                        await loadBoardData(context.data.boardId);
                    } else {
                        log('No board context from SDK, using URL parameters');
                        if (params.boardId) {
                            showBoardContext(params);
                        }
                    }
                } catch (contextError) {
                    log(`Context error: ${contextError.message}`);
                    updateStatus(`‚ö†Ô∏è SDK context failed, using URL data`, 'warning');
                    
                    if (params.boardId) {
                        showBoardContext(params);
                    }
                }

                log('=== TEST COMPLETED ===');

            } catch (error) {
                log(`Test failed: ${error.message}`);
                updateStatus(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }

        // Show board context from URL parameters
        function showBoardContext(params) {
            log('Displaying board context from URL parameters');
            
            const boardSection = document.getElementById('boardSection');
            const boardInfo = document.getElementById('boardInfo');
            
            if (boardSection && boardInfo) {
                boardInfo.innerHTML = `
                    <h3>üìã Board Context (from URL)</h3>
                    <div><strong>Board ID:</strong> ${params.boardId}</div>
                    <div><strong>Session Token:</strong> ${params.sessionToken ? 'Available' : 'Not available'}</div>
                    <div><strong>Instance ID:</strong> ${params.instanceId || 'Not available'}</div>
                    <div style="margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 4px; font-size: 14px;">
                        <strong>üéØ Success!</strong> Your Monday.com app is properly connected and receiving board context.
                        To see task data, the Monday SDK needs to be accessible, but your app integration is working correctly.
                    </div>
                `;
                
                boardSection.style.display = 'block';
                updateStatus('‚úÖ Board context loaded from URL parameters', 'success');
            }
        }

        // Load board data via Monday API
        async function loadBoardData(boardId) {
            if (!monday) {
                log('Cannot load board data - SDK not available');
                return;
            }

            try {
                log(`Loading board data for: ${boardId}`);
                
                const query = `
                    query {
                        boards(ids: [${boardId}]) {
                            id
                            name
                            description
                            items_count
                            items {
                                id
                                name
                                column_values {
                                    title
                                    text
                                    type
                                    value
                                }
                            }
                        }
                    }
                `;

                const response = await monday.api(query);
                log(`API Response: ${JSON.stringify(response, null, 2)}`);

                if (response.data && response.data.boards && response.data.boards.length > 0) {
                    const board = response.data.boards[0];
                    displayBoardData(board);
                    updateStatus(`‚úÖ Board data loaded: ${board.name} (${board.items.length} tasks)`, 'success');
                } else {
                    log('No board data in API response');
                    updateStatus('‚ùå No board data received from API', 'error');
                }

            } catch (error) {
                log(`Board data error: ${error.message}`);
                updateStatus(`‚ùå Failed to load board data: ${error.message}`, 'error');
            }
        }

        // Display board data in UI
        function displayBoardData(board) {
            log(`Displaying data for board: ${board.name}`);
            
            const boardSection = document.getElementById('boardSection');
            const boardInfo = document.getElementById('boardInfo');
            const taskContainer = document.getElementById('taskContainer');
            
            if (!boardSection || !boardInfo || !taskContainer) return;

            // Board information
            boardInfo.innerHTML = `
                <h3>üìã ${board.name}</h3>
                <div><strong>Board ID:</strong> ${board.id}</div>
                <div><strong>Total Items:</strong> ${board.items_count}</div>
                <div><strong>Description:</strong> ${board.description || 'No description'}</div>
            `;

            // Task cards
            if (board.items && board.items.length > 0) {
                taskContainer.innerHTML = `
                    <h3>üìù Tasks (${board.items.length})</h3>
                    <div class="task-grid">
                        ${board.items.map(item => {
                            // Extract useful column data
                            let status = 'No status';
                            let timeline = 'No timeline';
                            let assignee = 'No assignee';
                            
                            item.column_values.forEach(col => {
                                if (col.type === 'status' && col.text) {
                                    status = col.text;
                                }
                                if (col.type === 'timeline' && col.text) {
                                    timeline = col.text;
                                }
                                if (col.type === 'people' && col.text) {
                                    assignee = col.text;
                                }
                            });

                            return `
                                <div class="task-card">
                                    <div class="task-title">${item.name}</div>
                                    <div class="task-details">
                                        <div><strong>ID:</strong> ${item.id}</div>
                                        <div><strong>Status:</strong> ${status}</div>
                                        <div><strong>Timeline:</strong> ${timeline}</div>
                                        <div><strong>Assignee:</strong> ${assignee}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                taskContainer.innerHTML = '<div class="task-card">No tasks found in this board.</div>';
            }

            boardSection.style.display = 'block';
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            log('CCPM Board Viewer loaded');
            log(`Current URL: ${window.location.href}`);
            
            // Wait a moment for Monday.com environment to initialize
            setTimeout(() => {
                runTest();
            }, 1000);
        });
    </script>
</body>
</html>
