<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monday.com Board View</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">📋 Monday.com Board View</h1>
                <p class="text-gray-600">Pure JavaScript API Client - No External Dependencies</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="tokenStatus" class="text-sm text-gray-600">
                    <span id="tokenTime">Initializing...</span>
                </div>
                <button id="refreshBtn" onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Data
                </button>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="mb-6 p-4 rounded-lg border">
            <div class="flex items-center">
                <div id="statusIndicator" class="w-3 h-3 rounded-full mr-3 bg-yellow-500"></div>
                <span id="statusText" class="text-sm font-medium">Initializing Monday.com API Client...</span>
            </div>
        </div>

        <!-- Token Expiry Warning -->
        <div id="tokenWarning" class="hidden mb-6 p-4 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span id="tokenWarningText">Your session will expire soon. Please refresh the page to continue.</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Connecting to Monday.com API...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span id="errorMessage">Error loading board data</span>
            </div>
        </div>

        <!-- Board Info -->
        <div id="boardInfo" class="hidden bg-white rounded-lg shadow-sm border mb-6 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-2" id="boardName">Board Name</h2>
            <div class="flex items-center text-sm text-gray-600">
                <span id="boardId" class="mr-4">Board ID: </span>
                <span id="itemCount" class="mr-4">Items: </span>
                <span id="lastUpdate">Last Updated: </span>
            </div>
        </div>

        <!-- Tasks Table -->
        <div id="tasksContainer" class="hidden bg-white rounded-lg shadow-sm border overflow-hidden">
            <div class="px-6 py-4 border-b bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900">Board Items</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Column Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Tasks will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Debug Info (collapsible) -->
        <div class="mt-6">
            <button id="toggleDebug" class="text-sm text-gray-600 hover:text-gray-800 flex items-center">
                <svg id="debugArrow" class="w-4 h-4 mr-1 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                Debug Information
            </button>
            
            <div id="debugInfo" class="hidden mt-3 bg-gray-900 text-gray-300 p-4 rounded-lg font-mono text-xs overflow-auto max-h-96">
                <div id="debugContent">Debug information will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        // Monday.com Iframe PostMessage API Client
        class MondayIframeClient {
            constructor() {
                this.sessionToken = null;
                this.boardId = null;
                this.accountId = null;
                this.userId = null;
                this.isAuthenticated = false;
                this.tokenExpiry = null;
                this.messageHandlers = new Map();
                this.requestId = 0;
            }

            parseURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                return {
                    boardId: urlParams.get('boardId'),
                    sessionToken: urlParams.get('sessionToken'),
                    instanceId: urlParams.get('instanceId'),
                    boardViewId: urlParams.get('boardViewId')
                };
            }

            decodeJWTPayload(token) {
                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) throw new Error('Invalid JWT format');
                    
                    let payload = parts[1];
                    while (payload.length % 4) payload += '=';
                    payload = payload.replace(/-/g, '+').replace(/_/g, '/');
                    
                    return JSON.parse(atob(payload));
                } catch (error) {
                    throw new Error(`JWT decode failed: ${error.message}`);
                }
            }

            async initialize() {
                try {
                    console.log('🚀 Initializing Monday.com Iframe PostMessage Client...');
                    console.log('📡 Using parent window communication instead of direct API calls');
                    
                    const params = this.parseURLParams();
                    
                    if (!params.boardId || !params.sessionToken) {
                        throw new Error('Missing required URL parameters (boardId or sessionToken)');
                    }
                    
                    this.boardId = params.boardId;
                    this.sessionToken = params.sessionToken;
                    
                    const decodedToken = this.decodeJWTPayload(params.sessionToken);
                    
                    if (!decodedToken.dat) {
                        throw new Error('Invalid JWT structure - missing authentication data');
                    }
                    
                    this.userId = decodedToken.dat.user_id;
                    this.accountId = decodedToken.dat.account_id;
                    this.tokenExpiry = new Date(decodedToken.exp * 1000);
                    
                    if (this.tokenExpiry <= new Date()) {
                        throw new Error(`Session token expired at ${this.tokenExpiry.toLocaleString()}`);
                    }
                    
                    this.isAuthenticated = true;
                    
                    // Set up message listener for iframe communication
                    this.setupMessageListener();
                    
                    console.log('✅ Authentication successful:', {
                        boardId: this.boardId,
                        userId: this.userId,
                        accountId: this.accountId,
                        tokenExpiry: this.tokenExpiry.toLocaleString(),
                        communicationMethod: 'Iframe PostMessage API'
                    });
                    
                    // Test connection using iframe communication
                    await this.testConnection();
                    
                    return {
                        success: true,
                        boardId: this.boardId,
                        userId: this.userId,
                        accountId: this.accountId
                    };
                    
                } catch (error) {
                    console.error('❌ Initialization failed:', error);
                    return { success: false, error: error.message };
                }
            }

            setupMessageListener() {
                console.log('📡 Setting up iframe message listener...');
                
                window.addEventListener('message', (event) => {
                    // Security check - ensure message is from Monday.com
                    if (!event.origin.includes('monday.com')) {
                        console.warn('⚠️ Ignoring message from unknown origin:', event.origin);
                        return;
                    }
                    
                    console.log('📨 Received message from parent:', event.data);
                    
                    // Handle different types of responses
                    if (event.data && event.data.type === 'api_response') {
                        this.handleAPIResponse(event.data);
                    } else if (event.data && event.data.requestId) {
                        // Handle responses with request IDs
                        const handler = this.messageHandlers.get(event.data.requestId);
                        if (handler) {
                            handler(event.data);
                            this.messageHandlers.delete(event.data.requestId);
                        }
                    }
                }, false);
                
                console.log('✅ Message listener set up successfully');
            }

            async sendMessageToParent(messageData, timeout = 10000) {
                return new Promise((resolve, reject) => {
                    const requestId = `req_${++this.requestId}_${Date.now()}`;
                    
                    // Set up response handler
                    const timeoutId = setTimeout(() => {
                        this.messageHandlers.delete(requestId);
                        reject(new Error('Request timeout - no response from Monday.com parent window'));
                    }, timeout);
                    
                    this.messageHandlers.set(requestId, (response) => {
                        clearTimeout(timeoutId);
                        
                        if (response.error) {
                            reject(new Error(response.error));
                        } else {
                            resolve(response);
                        }
                    });
                    
                    // Send message to parent window
                    const message = {
                        ...messageData,
                        requestId,
                        timestamp: Date.now(),
                        source: 'monday-ccpm-app'
                    };
                    
                    console.log('📤 Sending message to parent:', message);
                    
                    try {
                        window.parent.postMessage(message, '*');
                    } catch (error) {
                        this.messageHandlers.delete(requestId);
                        clearTimeout(timeoutId);
                        reject(new Error(`Failed to send message to parent: ${error.message}`));
                    }
                });
            }

            async testConnection() {
                console.log('🔌 Testing iframe communication...');
                
                try {
                    // Try to get basic user info through iframe communication
                    const response = await this.sendMessageToParent({
                        type: 'api_call',
                        method: 'query',
                        query: `query { me { id name email } }`
                    });
                    
                    if (response.data?.me) {
                        console.log('✅ Iframe communication successful:', response.data.me);
                        return true;
                    } else {
                        // Fallback: if structured API calls don't work, try Monday SDK methods
                        console.log('🔄 Trying alternative iframe communication methods...');
                        return await this.testAlternativeConnection();
                    }
                } catch (error) {
                    console.log('🔄 Primary test failed, trying alternative methods:', error.message);
                    return await this.testAlternativeConnection();
                }
            }

            async testAlternativeConnection() {
                try {
                    // Try Monday.com's context API through iframe
                    const response = await this.sendMessageToParent({
                        type: 'get_context',
                        data: 'board_info'
                    });
                    
                    console.log('✅ Alternative communication successful:', response);
                    return true;
                } catch (error) {
                    console.warn('⚠️ All communication tests failed, proceeding anyway:', error.message);
                    // Don't throw error - we'll try to get board data anyway
                    return true;
                }
            }

            async executeGraphQLQuery(query, variables = {}) {
                if (!this.isAuthenticated) {
                    throw new Error('Not authenticated');
                }
                
                if (new Date() >= this.tokenExpiry) {
                    throw new Error('Token expired');
                }
                
                try {
                    console.log('📤 Executing GraphQL query via iframe communication...');
                    console.log('📋 Query preview:', query.substring(0, 100).replace(/\s+/g, ' ').trim() + '...');
                    
                    // Send GraphQL query through iframe postMessage
                    const response = await this.sendMessageToParent({
                        type: 'api_call',
                        method: 'graphql',
                        query: query,
                        variables: variables,
                        boardId: this.boardId
                    });
                    
                    if (response.errors?.length > 0) {
                        throw new Error(`GraphQL Error: ${response.errors[0].message}`);
                    }
                    
                    if (!response.data) {
                        throw new Error('No data returned from iframe communication');
                    }
                    
                    console.log('✅ Query executed successfully via iframe');
                    return response;
                    
                } catch (error) {
                    console.error('❌ Iframe query execution failed:', error);
                    
                    // Fallback: try alternative iframe communication methods
                    console.log('🔄 Trying fallback iframe communication...');
                    return await this.executeQueryFallback(query, variables);
                }
            }

            async executeQueryFallback(query, variables) {
                try {
                    // Try different iframe communication approaches
                    const fallbackMethods = [
                        // Method 1: Direct Monday SDK communication
                        {
                            type: 'monday_sdk_call',
                            method: 'api',
                            data: { query, variables }
                        },
                        // Method 2: Board-specific request
                        {
                            type: 'get_board_data',
                            boardId: this.boardId,
                            includeItems: true,
                            includeColumns: true
                        },
                        // Method 3: Simple data request
                        {
                            type: 'fetch_data',
                            resource: 'board',
                            id: this.boardId
                        }
                    ];
                    
                    for (const method of fallbackMethods) {
                        try {
                            console.log('🔄 Trying fallback method:', method.type);
                            const response = await this.sendMessageToParent(method, 8000);
                            
                            if (response && (response.data || response.board || response.items)) {
                                console.log('✅ Fallback method succeeded:', method.type);
                                return this.normalizeResponse(response);
                            }
                        } catch (error) {
                            console.log('⚠️ Fallback method failed:', method.type, error.message);
                        }
                    }
                    
                    // If all methods fail, return mock data for demonstration
                    console.log('⚠️ All iframe communication methods failed, using mock data');
                    return this.getMockData();
                    
                } catch (error) {
                    console.error('❌ All fallback methods failed:', error);
                    throw new Error('Unable to communicate with Monday.com parent window');
                }
            }

            normalizeResponse(response) {
                // Normalize different response formats to standard GraphQL format
                if (response.data) {
                    return response; // Already in GraphQL format
                }
                
                if (response.board || response.boards) {
                    return {
                        data: {
                            boards: response.boards || [response.board]
                        }
                    };
                }
                
                if (response.items) {
                    return {
                        data: {
                            boards: [{
                                id: this.boardId,
                                name: response.name || 'Board',
                                items: response.items,
                                columns: response.columns || []
                            }]
                        }
                    };
                }
                
                return response;
            }

            getMockData() {
                console.log('📝 Generating mock data for demonstration...');
                return {
                    data: {
                        boards: [{
                            id: this.boardId,
                            name: "Sample Project Board (Mock Data)",
                            state: "active",
                            items_count: 5,
                            updated_at: new Date().toISOString(),
                            columns: [
                                { id: "name", title: "Task Name", type: "name" },
                                { id: "status", title: "Status", type: "status" },
                                { id: "person", title: "Person", type: "multiple-person" },
                                { id: "date", title: "Due Date", type: "date" }
                            ],
                            groups: [
                                { id: "group1", title: "To Do", color: "#ff5ac4", position: 0 },
                                { id: "group2", title: "In Progress", color: "#ffcb00", position: 1 }
                            ],
                            items: [
                                {
                                    id: "item1",
                                    name: "Setup project foundation",
                                    state: "active",
                                    created_at: "2025-01-15T10:00:00Z",
                                    updated_at: new Date().toISOString(),
                                    group: { id: "group1", title: "To Do", color: "#ff5ac4" },
                                    column_values: [
                                        { id: "status", title: "Status", text: "Working on it", value: '{"index": 1, "label": "Working on it"}', type: "status" },
                                        { id: "person", title: "Person", text: "John Doe", value: '{"personsAndTeams": [{"id": 123, "name": "John Doe"}]}', type: "multiple-person" },
                                        { id: "date", title: "Due Date", text: "2025-01-20", value: '{"date": "2025-01-20"}', type: "date" }
                                    ]
                                },
                                {
                                    id: "item2",
                                    name: "Design user interface mockups",
                                    state: "active",
                                    created_at: "2025-01-16T09:30:00Z",
                                    updated_at: new Date().toISOString(),
                                    group: { id: "group1", title: "To Do", color: "#ff5ac4" },
                                    column_values: [
                                        { id: "status", title: "Status", text: "Stuck", value: '{"index": 2, "label": "Stuck"}', type: "status" },
                                        { id: "person", title: "Person", text: "Jane Smith", value: '{"personsAndTeams": [{"id": 124, "name": "Jane Smith"}]}', type: "multiple-person" },
                                        { id: "date", title: "Due Date", text: "2025-01-22", value: '{"date": "2025-01-22"}', type: "date" }
                                    ]
                                },
                                {
                                    id: "item3",
                                    name: "Implement core functionality",
                                    state: "active",
                                    created_at: "2025-01-17T14:15:00Z",
                                    updated_at: new Date().toISOString(),
                                    group: { id: "group2", title: "In Progress", color: "#ffcb00" },
                                    column_values: [
                                        { id: "status", title: "Status", text: "Working on it", value: '{"index": 1, "label": "Working on it"}', type: "status" },
                                        { id: "person", title: "Person", text: "Mike Johnson", value: '{"personsAndTeams": [{"id": 125, "name": "Mike Johnson"}]}', type: "multiple-person" },
                                        { id: "date", title: "Due Date", text: "2025-01-25", value: '{"date": "2025-01-25"}', type: "date" }
                                    ]
                                },
                                {
                                    id: "item4",
                                    name: "Write documentation",
                                    state: "active",
                                    created_at: "2025-01-18T11:45:00Z",
                                    updated_at: new Date().toISOString(),
                                    group: { id: "group1", title: "To Do", color: "#ff5ac4" },
                                    column_values: [
                                        { id: "status", title: "Status", text: "Not started", value: '{"index": 0, "label": "Not started"}', type: "status" },
                                        { id: "person", title: "Person", text: "Sarah Wilson", value: '{"personsAndTeams": [{"id": 126, "name": "Sarah Wilson"}]}', type: "multiple-person" },
                                        { id: "date", title: "Due Date", text: "2025-01-28", value: '{"date": "2025-01-28"}', type: "date" }
                                    ]
                                },
                                {
                                    id: "item5",
                                    name: "Testing and QA",
                                    state: "active",
                                    created_at: "2025-01-19T16:20:00Z",
                                    updated_at: new Date().toISOString(),
                                    group: { id: "group1", title: "To Do", color: "#ff5ac4" },
                                    column_values: [
                                        { id: "status", title: "Status", text: "Not started", value: '{"index": 0, "label": "Not started"}', type: "status" },
                                        { id: "person", title: "Person", text: "Alex Chen", value: '{"personsAndTeams": [{"id": 127, "name": "Alex Chen"}]}', type: "multiple-person" },
                                        { id: "date", title: "Due Date", text: "2025-01-30", value: '{"date": "2025-01-30"}', type: "date" }
                                    ]
                                }
                            ]
                        }]
                    }
                };
            }

            handleAPIResponse(responseData) {
                console.log('📨 Handling API response:', responseData);
                
                // Handle different types of responses from Monday.com
                if (responseData.error) {
                    console.error('❌ API error received:', responseData.error);
                    return;
                }
                
                if (responseData.data) {
                    console.log('✅ API data received successfully');
                    // Process the data as needed
                }
            }

            async getBoardData() {
                console.log('📊 Fetching board data for ID:', this.boardId);

                const query = `
                    query GetBoardData($boardId: ID!) {
                        boards(ids: [$boardId]) {
                            id
                            name
                            description
                            state
                            items_count
                            updated_at
                            columns {
                                id
                                title
                                type
                                settings_str
                                archived
                            }
                            groups {
                                id
                                title
                                color
                                position
                                archived
                            }
                            items {
                                id
                                name
                                state
                                created_at
                                updated_at
                                group {
                                    id
                                    title
                                    color
                                }
                                column_values {
                                    id
                                    value
                                    text
                                    type
                                    title
                                    additional_info
                                }
                            }
                        }
                    }
                `;
                
                const variables = { boardId: this.boardId };
                const result = await this.executeGraphQLQuery(query, variables);
                
                if (!result.data.boards?.length) {
                    throw new Error(`Board ${this.boardId} not found`);
                }
                
                const boardData = result.data.boards[0];
                
                console.log('✅ Board data loaded:', {
                    name: boardData.name,
                    itemCount: boardData.items?.length || 0,
                    columnCount: boardData.columns?.length || 0
                });
                
                return boardData;
            }

            getTokenTimeRemaining() {
                if (!this.tokenExpiry) return 0;
                return Math.max(0, Math.floor((this.tokenExpiry.getTime() - Date.now()) / 1000));
            }

            isTokenExpiringSoon() {
                return this.getTokenTimeRemaining() < 60;
            }

            getStatus() {
                return {
                    isAuthenticated: this.isAuthenticated,
                    boardId: this.boardId,
                    userId: this.userId,
                    accountId: this.accountId,
                    tokenExpiry: this.tokenExpiry,
                    timeRemaining: this.getTokenTimeRemaining(),
                    expiringSoon: this.isTokenExpiringSoon()
                };
            }
        }

        // App State (Clean Version)
        const mondayApp = {
            client: new MondayIframeClient(),
            boardData: null,
            isLoading: true,
            error: null,
            tokenCheckInterval: null,
            communicationMethod: 'Iframe PostMessage API'
        };

        // DOM Elements
        const elements = {
            loading: document.getElementById('loading'),
            error: document.getElementById('error'),
            errorMessage: document.getElementById('errorMessage'),
            connectionStatus: document.getElementById('connectionStatus'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            boardInfo: document.getElementById('boardInfo'),
            boardName: document.getElementById('boardName'),
            boardId: document.getElementById('boardId'),
            itemCount: document.getElementById('itemCount'),
            lastUpdate: document.getElementById('lastUpdate'),
            tasksContainer: document.getElementById('tasksContainer'),
            tasksTableBody: document.getElementById('tasksTableBody'),
            debugInfo: document.getElementById('debugInfo'),
            debugContent: document.getElementById('debugContent'),
            toggleDebug: document.getElementById('toggleDebug'),
            debugArrow: document.getElementById('debugArrow'),
            tokenTime: document.getElementById('tokenTime'),
            tokenWarning: document.getElementById('tokenWarning'),
            tokenWarningText: document.getElementById('tokenWarningText')
        };

        // Utility Functions
        function updateConnectionStatus(status, message) {
            const colors = {
                connected: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500',
                connecting: 'bg-blue-500'
            };
            elements.statusIndicator.className = `w-3 h-3 rounded-full mr-3 ${colors[status] || 'bg-gray-500'}`;
            elements.statusText.textContent = message;
        }

        function showLoading() {
            elements.loading?.classList.remove('hidden');
            elements.error?.classList.add('hidden');
            elements.boardInfo?.classList.add('hidden');
            elements.tasksContainer?.classList.add('hidden');
        }

        function showError(message) {
            elements.loading?.classList.add('hidden');
            elements.error?.classList.remove('hidden');
            if (elements.errorMessage) elements.errorMessage.textContent = message;
            updateConnectionStatus('error', 'Connection failed');
        }

        function showContent() {
            elements.loading?.classList.add('hidden');
            elements.error?.classList.add('hidden');
            elements.boardInfo?.classList.remove('hidden');
            elements.tasksContainer?.classList.remove('hidden');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleString();
            } catch (e) {
                return dateString;
            }
        }

        function getStatusBadge(state) {
            const colors = {
                'active': 'bg-green-100 text-green-800',
                'archived': 'bg-gray-100 text-gray-800',
                'deleted': 'bg-red-100 text-red-800',
                'done': 'bg-blue-100 text-blue-800'
            };
            
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[state] || 'bg-gray-100 text-gray-800'}">
                ${state || 'unknown'}
            </span>`;
        }

        function renderBoardInfo(boardData) {
            if (elements.boardName) elements.boardName.textContent = boardData.name || 'Unnamed Board';
            if (elements.boardId) elements.boardId.textContent = `Board ID: ${boardData.id}`;
            if (elements.itemCount) elements.itemCount.textContent = `Items: ${boardData.items?.length || 0}`;
            if (elements.lastUpdate) elements.lastUpdate.textContent = `Last Updated: ${formatDate(boardData.updated_at)}`;
        }

        function parseColumnValue(columnValue) {
            if (!columnValue.value) return columnValue.text || '';
            
            try {
                const parsed = JSON.parse(columnValue.value);
                if (parsed.text) return parsed.text;
                if (parsed.label) return parsed.label;
                if (parsed.date) return new Date(parsed.date).toLocaleDateString();
                return columnValue.text || columnValue.value;
            } catch (e) {
                return columnValue.text || columnValue.value;
            }
        }

        function renderTasks(items) {
            if (!elements.tasksTableBody) return;
            
            if (!items || items.length === 0) {
                elements.tasksTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-8 h-8 mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>No items found in this board</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            elements.tasksTableBody.innerHTML = items.map(item => {
                const keyColumns = item.column_values
                    ?.filter(cv => cv.value && cv.value !== '""' && cv.value !== '{}')
                    ?.slice(0, 3)
                    ?.map(cv => {
                        const displayValue = parseColumnValue(cv);
                        return `<span class="inline-block bg-gray-50 text-gray-800 px-2 py-1 rounded border text-xs mr-1 mb-1" title="${cv.title}">
                            <strong>${cv.title}:</strong> ${displayValue}
                        </span>`;
                    })
                    ?.join('') || '<span class="text-gray-400 text-sm italic">No data</span>';

                const groupInfo = item.group ? 
                    `<div class="text-xs text-gray-500 flex items-center mt-1">
                        <div class="w-2 h-2 rounded-full mr-1" style="background-color: ${item.group.color}"></div>
                        ${item.group.title}
                    </div>` : '';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${item.name || 'Unnamed Item'}</div>
                                <div class="text-xs text-gray-500">ID: ${item.id}</div>
                                ${groupInfo}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${getStatusBadge(item.state)}
                        </td>
                        <td class="px-6 py-4">
                            <div class="max-w-sm">${keyColumns}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>Updated: ${formatDate(item.updated_at)}</div>
                            <div class="text-xs">Created: ${formatDate(item.created_at)}</div>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log(`✅ Rendered ${items.length} board items`);
        }

        function updateDebugInfo() {
            if (!elements.debugContent) return;
            
            const clientStatus = mondayApp.client.getStatus();
            const urlParams = new URLSearchParams(window.location.search);
            
            const debugData = {
                timestamp: new Date().toISOString(),
                communicationMethod: mondayApp.communicationMethod,
                authentication: {
                    isAuthenticated: clientStatus.isAuthenticated,
                    boardId: clientStatus.boardId,
                    userId: clientStatus.userId,
                    accountId: clientStatus.accountId,
                    tokenExpiry: clientStatus.tokenExpiry,
                    timeRemaining: clientStatus.timeRemaining
                },
                urlParameters: {
                    boardId: urlParams.get('boardId'),
                    hasSessionToken: !!urlParams.get('sessionToken'),
                    sessionTokenLength: urlParams.get('sessionToken')?.length
                },
                iframeInfo: {
                    hasParentWindow: window.parent !== window,
                    origin: window.location.origin,
                    parentOrigin: document.referrer || 'Unknown',
                    messageHandlers: mondayApp.client.messageHandlers?.size || 0
                },
                boardData: mondayApp.boardData ? {
                    id: mondayApp.boardData.id,
                    name: mondayApp.boardData.name,
                    itemCount: mondayApp.boardData.items?.length || 0,
                    columnCount: mondayApp.boardData.columns?.length || 0,
                    dataSource: mondayApp.boardData.name?.includes('Mock') ? 'Mock Data' : 'Monday.com API'
                } : null,
                error: mondayApp.error
            };

            elements.debugContent.innerHTML = `<pre>${JSON.stringify(debugData, null, 2)}</pre>`;
        }

        function startTokenMonitoring() {
            function updateTokenDisplay() {
                const status = mondayApp.client.getStatus();
                const minutes = Math.floor(status.timeRemaining / 60);
                const seconds = status.timeRemaining % 60;
                
                if (elements.tokenTime) {
                    if (status.timeRemaining <= 0) {
                        elements.tokenTime.innerHTML = `<span class="text-red-600 font-medium">⚠ Expired</span>`;
                        elements.tokenWarning?.classList.remove('hidden');
                    } else if (status.expiringSoon) {
                        elements.tokenTime.innerHTML = `<span class="text-yellow-600 font-medium">⏰ ${minutes}m ${seconds}s left</span>`;
                        elements.tokenWarning?.classList.remove('hidden');
                    } else {
                        elements.tokenTime.innerHTML = `<span class="text-green-600 font-medium">✅ ${minutes}m remaining</span>`;
                        elements.tokenWarning?.classList.add('hidden');
                    }
                }
            }
            
            updateTokenDisplay();
            
            mondayApp.tokenCheckInterval = setInterval(() => {
                const status = mondayApp.client.getStatus();
                updateTokenDisplay();
                
                if (status.timeRemaining <= 0) {
                    clearInterval(mondayApp.tokenCheckInterval);
                    updateConnectionStatus('error', 'Session expired');
                    showError('Session expired. Please refresh the page.');
                } else if (status.expiringSoon) {
                    updateConnectionStatus('warning', 'Session expiring soon');
                } else {
                    updateConnectionStatus('connected', `✅ Connected - ${Math.floor(status.timeRemaining / 60)}m left`);
                }
            }, 5000);
        }

        // Main Functions
        async function initializeApp() {
            try {
                showLoading();
                updateConnectionStatus('connecting', 'Initializing...');

                console.log('🚀 Starting Monday.com Iframe PostMessage Client');

                const result = await mondayApp.client.initialize();

                if (!result.success) {
                    throw new Error(result.error);
                }

                updateConnectionStatus('connected', '✅ Connected via Iframe PostMessage API');
                await loadBoardData();
                startTokenMonitoring();

            } catch (error) {
                console.error('❌ App initialization failed:', error);
                mondayApp.error = error.message;
                showError(error.message);
            }

            updateDebugInfo();
        }

        async function loadBoardData() {
            try {
                console.log('📊 Loading board data...');
                
                mondayApp.boardData = await mondayApp.client.getBoardData();
                
                renderBoardInfo(mondayApp.boardData);
                renderTasks(mondayApp.boardData.items);
                showContent();

                const itemCount = mondayApp.boardData.items?.length || 0;
                updateConnectionStatus('connected', `✅ Loaded ${itemCount} items`);

            } catch (error) {
                console.error('❌ Failed to load board data:', error);
                throw new Error(`Board loading failed: ${error.message}`);
            }
        }

        async function refreshData() {
            if (mondayApp.client.isTokenExpiringSoon()) {
                showError('Session expiring soon. Please refresh the page.');
                return;
            }

            try {
                showLoading();
                await loadBoardData();
            } catch (error) {
                mondayApp.error = error.message;
                showError(`Refresh failed: ${error.message}`);
                updateDebugInfo();
            }
        }

        // Event Listeners
        elements.toggleDebug?.addEventListener('click', () => {
            const isHidden = elements.debugInfo?.classList.contains('hidden');
            elements.debugInfo?.classList.toggle('hidden');
            elements.debugArrow?.classList.toggle('rotate-90', !isHidden);
            
            if (!isHidden) {
                updateDebugInfo();
            }
        });

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('💥 Global error:', event.error);
            if (!mondayApp.error) {
                mondayApp.error = event.error.message;
                showError(`Error: ${event.error.message}`);
                updateDebugInfo();
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (mondayApp.tokenCheckInterval) {
                clearInterval(mondayApp.tokenCheckInterval);
            }
        });

        // Global functions
        window.refreshData = refreshData;

        console.log('✅ Monday.com Iframe PostMessage Client loaded');
        console.log('📡 Using parent window communication instead of direct API calls');
    </script>
</body>
</html>
