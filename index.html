<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monday Board Connection - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-blue-600 text-white rounded-lg p-6 mb-6">
            <h1 class="text-2xl font-bold">Monday.com Board Connection - Fixed Version</h1>
            <p class="text-blue-100 mt-2">Enhanced Monday.com SDK integration</p>
        </div>

        <!-- Connection Status -->
        <div class="bg-white rounded-lg border p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">üîó Enhanced Connection Status</h2>
            <div id="connectionInfo" class="space-y-2 text-sm">
                <div>Environment: <span id="envDisplay" class="font-mono font-bold">Detecting...</span></div>
                <div>SDK Loading: <span id="sdkLoading" class="font-mono">Checking...</span></div>
                <div>SDK Status: <span id="sdkStatus" class="font-mono">Waiting...</span></div>
                <div>Context Status: <span id="contextStatus" class="font-mono">Waiting...</span></div>
                <div>Board ID: <span id="boardIdDisplay" class="font-mono">Not detected</span></div>
                <div>User ID: <span id="userIdDisplay" class="font-mono">Not detected</span></div>
                <div>Account ID: <span id="accountIdDisplay" class="font-mono">Not detected</span></div>
                <div>Window Location: <span id="windowLocation" class="font-mono text-xs">Loading...</span></div>
                <div>User Agent: <span id="userAgent" class="font-mono text-xs">Loading...</span></div>
            </div>
            
            <div class="mt-4 space-x-2">
                <button onclick="forceReconnect()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    üîÑ Force Reconnect
                </button>
                <button onclick="loadSDKManually()" 
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    üì• Load SDK Manually
                </button>
                <button onclick="testDirectAPI()" 
                        class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                    üîß Test Direct API
                </button>
            </div>
        </div>

        <!-- Board Data -->
        <div id="boardDataSection" class="bg-white rounded-lg border p-6 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4">üìã Board Information</h2>
            <div id="boardInfo" class="mb-4 p-4 bg-gray-50 rounded">
                <!-- Board details will be populated here -->
            </div>
            
            <h3 class="text-md font-semibold mb-3">Tasks</h3>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 px-4 py-2 text-left">Task Name</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">ID</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Status</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Timeline</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBody">
                        <!-- Tasks will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Debug Console -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-6">
            <h2 class="text-lg font-semibold mb-4 text-white">üêõ Debug Console</h2>
            <div id="debugConsole" class="text-xs font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
Starting enhanced Monday.com connection...
            </div>
            <button onclick="clearDebug()" 
                    class="mt-2 px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">
                Clear Log
            </button>
        </div>
    </div>

    <script>
        // Enhanced logging and debugging
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toISOString().substring(11, 23);
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logMessage = `[${timestamp}] ${prefix} ${message}`;
            
            document.getElementById('debugConsole').textContent += logMessage + '\n';
            console.log(`[Monday App] ${message}`);
            
            // Auto-scroll to bottom
            const console = document.getElementById('debugConsole');
            console.scrollTop = console.scrollHeight;
        }

        function clearDebug() {
            document.getElementById('debugConsole').textContent = 'Debug log cleared.\n';
        }

        // Global variables
        let monday = null;
        let connectionAttempts = 0;
        let maxAttempts = 5;

        // Initialize environment detection
        function detectEnvironment() {
            const location = window.location;
            const userAgent = navigator.userAgent;
            
            document.getElementById('windowLocation').textContent = location.href;
            document.getElementById('userAgent').textContent = userAgent.substring(0, 60) + '...';
            
            debugLog(`Location: ${location.href}`);
            debugLog(`User Agent: ${userAgent.substring(0, 100)}...`);
            
            // Check if we're in an iframe (Monday.com apps run in iframes)
            const inIframe = window !== window.top;
            debugLog(`Running in iframe: ${inIframe}`);
            
            // Check for Monday.com specific indicators
            const isMondayContext = location.href.includes('monday.com') || 
                                   location.href.includes('auth.monday.com') ||
                                   document.referrer.includes('monday.com');
            debugLog(`Monday.com context detected: ${isMondayContext}`);
            
            document.getElementById('envDisplay').textContent = 
                inIframe && isMondayContext ? 'Monday.com App' : 
                inIframe ? 'Iframe (Unknown)' : 
                'Standalone Browser';
        }

        // Enhanced SDK loading with multiple attempts
        async function loadMondaySDK() {
            debugLog('Attempting to load Monday.com SDK...');
            document.getElementById('sdkLoading').textContent = 'Loading...';
            
            // Method 1: Check if already loaded
            if (typeof mondaySDK !== 'undefined') {
                debugLog('Monday SDK already available', 'success');
                document.getElementById('sdkLoading').textContent = '‚úÖ Already loaded';
                return initializeSDK();
            }
            
            // Method 2: Wait for SDK to load (it might be loading)
            debugLog('Waiting for SDK to load...');
            for (let i = 0; i < 10; i++) {
                if (typeof mondaySDK !== 'undefined') {
                    debugLog(`SDK became available after ${i * 500}ms`, 'success');
                    document.getElementById('sdkLoading').textContent = '‚úÖ Loaded';
                    return initializeSDK();
                }
                await new Promise(resolve => setTimeout(resolve, 500));
                debugLog(`SDK check attempt ${i + 1}/10`);
            }
            
            // Method 3: Try to load SDK manually
            debugLog('SDK not found, attempting manual load...', 'warning');
            return loadSDKManually();
        }

        // Manual SDK loading
        async function loadSDKManually() {
            debugLog('Loading Monday SDK script manually...');
            document.getElementById('sdkLoading').textContent = 'Manual loading...';
            
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = 'https://dapulse-res.cloudinary.com/image/upload/remote_logos/995333-ec8cea4e1cbd2bd50c4bb5e24c83df0b.js';
                script.onload = () => {
                    debugLog('SDK script loaded successfully', 'success');
                    document.getElementById('sdkLoading').textContent = '‚úÖ Manually loaded';
                    setTimeout(() => {
                        if (typeof mondaySDK !== 'undefined') {
                            debugLog('SDK now available after manual load', 'success');
                            initializeSDK();
                            resolve(true);
                        } else {
                            debugLog('SDK still not available after manual load', 'error');
                            document.getElementById('sdkLoading').textContent = '‚ùå Failed';
                            resolve(false);
                        }
                    }, 1000);
                };
                script.onerror = () => {
                    debugLog('Failed to load SDK script', 'error');
                    document.getElementById('sdkLoading').textContent = '‚ùå Script load failed';
                    resolve(false);
                };
                document.head.appendChild(script);
            });
        }

        // Initialize Monday SDK
        async function initializeSDK() {
            if (typeof mondaySDK === 'undefined') {
                debugLog('SDK still not available for initialization', 'error');
                document.getElementById('sdkStatus').textContent = '‚ùå Not available';
                return false;
            }

            try {
                debugLog('Initializing Monday SDK...');
                monday = mondaySDK();
                debugLog('Monday SDK initialized successfully', 'success');
                document.getElementById('sdkStatus').textContent = '‚úÖ Initialized';
                
                // Try to get context
                await getContext();
                return true;
                
            } catch (error) {
                debugLog(`Failed to initialize SDK: ${error.message}`, 'error');
                document.getElementById('sdkStatus').textContent = `‚ùå Init failed: ${error.message}`;
                return false;
            }
        }

        // Get context with enhanced error handling
        async function getContext() {
            if (!monday) {
                debugLog('Cannot get context - Monday SDK not initialized', 'error');
                return;
            }

            try {
                debugLog('Requesting context from Monday.com...');
                document.getElementById('contextStatus').textContent = 'Requesting...';
                
                // Add timeout to context request
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Context request timeout after 10s')), 10000)
                );
                
                const contextPromise = monday.get("context");
                
                const context = await Promise.race([contextPromise, timeoutPromise]);
                
                debugLog(`Context received: ${JSON.stringify(context, null, 2)}`, 'success');
                document.getElementById('contextStatus').textContent = '‚úÖ Received';
                
                // Display context data
                if (context && context.data) {
                    if (context.data.boardId) {
                        document.getElementById('boardIdDisplay').textContent = context.data.boardId;
                        debugLog(`Board ID: ${context.data.boardId}`, 'success');
                        
                        // Try to load board data
                        await loadBoardData(context.data.boardId);
                    } else {
                        debugLog('No board ID in context - app may not be opened from a board', 'warning');
                    }
                    
                    if (context.data.userId) {
                        document.getElementById('userIdDisplay').textContent = context.data.userId;
                        debugLog(`User ID: ${context.data.userId}`, 'success');
                    }
                    
                    if (context.data.accountId) {
                        document.getElementById('accountIdDisplay').textContent = context.data.accountId;
                        debugLog(`Account ID: ${context.data.accountId}`, 'success');
                    }
                } else {
                    debugLog('Context received but no data property', 'warning');
                    document.getElementById('contextStatus').textContent = '‚ö†Ô∏è No data';
                }
                
            } catch (error) {
                debugLog(`Context request failed: ${error.message}`, 'error');
                document.getElementById('contextStatus').textContent = `‚ùå ${error.message}`;
            }
        }

        // Load board data
        async function loadBoardData(boardId) {
            if (!monday) {
                debugLog('Cannot load board - SDK not available', 'error');
                return;
            }

            try {
                debugLog(`Loading board data for ID: ${boardId}...`);
                
                const query = `
                    query {
                        boards(ids: [${boardId}]) {
                            id
                            name
                            description
                            items_count
                            items {
                                id
                                name
                                state
                                column_values {
                                    id
                                    title
                                    value
                                    text
                                    type
                                }
                            }
                        }
                    }
                `;
                
                debugLog('Sending GraphQL query...');
                const response = await monday.api(query);
                
                debugLog(`API Response received: ${JSON.stringify(response, null, 2)}`, 'success');
                
                if (response.data && response.data.boards && response.data.boards.length > 0) {
                    const board = response.data.boards[0];
                    debugLog(`Board loaded successfully: "${board.name}"`, 'success');
                    displayBoardData(board);
                } else {
                    debugLog('No board data in API response', 'error');
                }
                
            } catch (error) {
                debugLog(`Failed to load board data: ${error.message}`, 'error');
            }
        }

        // Display board data
        function displayBoardData(board) {
            debugLog(`Displaying data for board: ${board.name}`);
            
            // Show board info
            document.getElementById('boardInfo').innerHTML = `
                <h3 class="font-semibold text-lg mb-2">${board.name}</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>ID:</strong> ${board.id}</div>
                    <div><strong>Items:</strong> ${board.items_count}</div>
                    <div><strong>Description:</strong> ${board.description || 'No description'}</div>
                </div>
            `;
            
            // Show tasks
            const tasksTableBody = document.getElementById('tasksTableBody');
            if (board.items && board.items.length > 0) {
                tasksTableBody.innerHTML = board.items.map(item => {
                    // Extract key information
                    let status = 'N/A';
                    let timeline = 'N/A';
                    let duration = 'N/A';
                    
                    item.column_values.forEach(col => {
                        if (col.type === 'status' && col.text) {
                            status = col.text;
                        }
                        if (col.type === 'timeline' && col.value) {
                            try {
                                const timelineData = JSON.parse(col.value);
                                if (timelineData.from && timelineData.to) {
                                    timeline = `${timelineData.from} ‚Üí ${timelineData.to}`;
                                    // Calculate duration
                                    const start = new Date(timelineData.from);
                                    const end = new Date(timelineData.to);
                                    const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                    duration = `${diffDays} days`;
                                }
                            } catch (e) {
                                debugLog(`Failed to parse timeline for ${item.name}`, 'warning');
                            }
                        }
                        if (col.type === 'numeric' && col.value && 
                            col.title.toLowerCase().includes('duration')) {
                            duration = `${col.value} days`;
                        }
                    });
                    
                    return `
                        <tr>
                            <td class="border border-gray-300 px-4 py-2 font-medium">${item.name}</td>
                            <td class="border border-gray-300 px-4 py-2 font-mono text-xs">${item.id}</td>
                            <td class="border border-gray-300 px-4 py-2">${status}</td>
                            <td class="border border-gray-300 px-4 py-2 text-xs">${timeline}</td>
                            <td class="border border-gray-300 px-4 py-2">${duration}</td>
                        </tr>
                    `;
                }).join('');
                
                debugLog(`Successfully displayed ${board.items.length} tasks`, 'success');
            } else {
                tasksTableBody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 px-4 py-2 text-center text-gray-500">No items found</td></tr>';
            }
            
            // Show the board data section
            document.getElementById('boardDataSection').classList.remove('hidden');
        }

        // Button functions
        async function forceReconnect() {
            debugLog('=== FORCE RECONNECT INITIATED ===');
            connectionAttempts++;
            
            // Reset status displays
            document.getElementById('sdkStatus').textContent = 'Reconnecting...';
            document.getElementById('contextStatus').textContent = 'Waiting...';
            document.getElementById('boardIdDisplay').textContent = 'Not detected';
            
            await loadMondaySDK();
        }

        async function loadSDKManually() {
            debugLog('=== MANUAL SDK LOAD INITIATED ===');
            await loadSDKManually();
        }

        async function testDirectAPI() {
            debugLog('=== DIRECT API TEST (Not implemented yet) ===');
            debugLog('This would test Monday.com API directly with token', 'warning');
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('=== MONDAY.COM APP STARTING ===');
            
            // Detect environment
            detectEnvironment();
            
            // Wait a bit for Monday.com to initialize
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Try to load SDK
            await loadMondaySDK();
        });
    </script>
</body>
</html>
