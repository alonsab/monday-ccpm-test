<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Monday.com Tasks</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 20px; background: #f8f9fa; color: #333;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { 
            background: #0073ea; color: white; padding: 24px; border-radius: 8px;
            margin-bottom: 24px; text-align: center;
        }
        .card { 
            background: white; border-radius: 8px; padding: 24px; margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e1e5e9;
        }
        .status { padding: 8px 16px; border-radius: 16px; font-size: 14px; font-weight: 600; }
        .status-success { background: #e8f5e8; color: #00ca72; }
        .status-warning { background: #fff3cd; color: #fdab3d; }
        .status-error { background: #ffe6e6; color: #e2445c; }
        
        .task-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .task-table th { 
            background: #f6f7fb; padding: 12px; text-align: left; font-weight: 600;
            border-bottom: 2px solid #e1e5e9; font-size: 14px;
        }
        .task-table td { 
            padding: 12px; border-bottom: 1px solid #e1e5e9; font-size: 14px;
        }
        .task-table tr:hover { background: #f8f9fa; }
        .task-name { font-weight: 600; color: #333; }
        .task-id { font-family: monospace; font-size: 12px; color: #676879; }
        
        button {
            background: #0073ea; color: white; border: none; padding: 12px 20px;
            border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;
        }
        button:hover { background: #005bb5; }
        
        .debug-log { 
            background: #1a1a1a; color: #00ff41; padding: 16px; font-family: monospace;
            font-size: 12px; border-radius: 6px; max-height: 300px; overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .loading { text-align: center; padding: 40px; }
        .spinner { 
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #0073ea;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã My Monday.com Board Tasks</h1>
            <p>Board ID: <span id="boardIdDisplay">Loading...</span></p>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <h2>üîó Connection Status</h2>
            <div id="connectionStatus">
                <span class="status status-warning">Connecting to Monday.com...</span>
            </div>
            <div style="margin-top: 16px;">
                <button onclick="loadTasks()">üîÑ Load My Tasks</button>
                <button onclick="testAPI()" style="background: #6200ea;">üß™ Test API</button>
            </div>
        </div>

        <!-- Tasks Display -->
        <div id="tasksSection" class="card" style="display: none;">
            <h2>üìù My Tasks</h2>
            <p id="tasksSummary">Loading tasks from your Monday.com board...</p>
            
            <table class="task-table">
                <thead>
                    <tr>
                        <th>Task Name</th>
                        <th>Monday.com ID</th>
                        <th>Status</th>
                        <th>Timeline</th>
                        <th>Duration</th>
                        <th>Assignee</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody">
                    <tr>
                        <td colspan="6" class="loading">
                            <div class="spinner"></div>
                            <p>Loading your tasks...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Debug Information -->
        <div class="card">
            <h2>üêõ Debug Information</h2>
            <div id="debugLog" class="debug-log">Starting Monday.com task loader...\n</div>
            <button onclick="clearLog()" style="background: #676879; margin-top: 12px;">Clear Log</button>
        </div>
    </div>

    <script>
        // Safe logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('debugLog');
            if (logEl) {
                logEl.textContent += `[${timestamp}] ${message}\n`;
                logEl.scrollTop = logEl.scrollHeight;
            }
            try {
                console.log(`[Monday Tasks] ${message}`);
            } catch (e) { /* Ignore console errors */ }
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'Log cleared.\n';
        }

        // Get Monday.com context from URL
        function getMondayContext() {
            const urlParams = new URLSearchParams(window.location.search);
            const context = {
                boardId: urlParams.get('boardId'),
                sessionToken: urlParams.get('sessionToken'),
                userId: urlParams.get('userId'),
                accountId: urlParams.get('accountId'),
                instanceId: urlParams.get('instanceId')
            };
            
            log(`Board ID: ${context.boardId}`);
            log(`Session Token: ${context.sessionToken ? 'Present' : 'Missing'}`);
            log(`User ID: ${context.userId}`);
            log(`Account ID: ${context.accountId}`);
            
            return context;
        }

        // Update connection status
        function updateConnectionStatus(message, type = 'info') {
            const statusEl = document.getElementById('connectionStatus');
            const className = type === 'success' ? 'status-success' : 
                           type === 'error' ? 'status-error' : 
                           type === 'warning' ? 'status-warning' : 'status-info';
            
            statusEl.innerHTML = `<span class="${className}">${message}</span>`;
            log(message);
        }

        // Try to access Monday.com API using session token
        async function loadTasksWithToken(boardId, sessionToken) {
            log('Attempting to load tasks using session token...');
            
            try {
                // Use Monday.com GraphQL API directly with session token
                const query = `
                    query {
                        boards(ids: [${boardId}]) {
                            id
                            name
                            description
                            items_count
                            items {
                                id
                                name
                                state
                                created_at
                                updated_at
                                column_values {
                                    id
                                    title
                                    value
                                    text
                                    type
                                }
                            }
                            columns {
                                id
                                title
                                type
                            }
                        }
                    }
                `;

                const response = await fetch('https://api.monday.com/v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`,
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log(`API Response: ${JSON.stringify(data, null, 2)}`);

                if (data.errors) {
                    throw new Error(`GraphQL errors: ${JSON.stringify(data.errors)}`);
                }

                if (data.data && data.data.boards && data.data.boards.length > 0) {
                    const board = data.data.boards[0];
                    log(`‚úÖ Board loaded: "${board.name}" with ${board.items_count} items`);
                    displayTasks(board);
                    return true;
                } else {
                    throw new Error('No board data found in response');
                }

            } catch (error) {
                log(`‚ùå API request failed: ${error.message}`);
                throw error;
            }
        }

        // Try to access Monday SDK
        async function loadTasksWithSDK(boardId) {
            log('Attempting to load tasks using Monday SDK...');
            
            // Try to find Monday SDK
            const sdkSources = [
                () => window.mondaySDK,
                () => window.monday,
                () => parent?.mondaySDK,
                () => parent?.monday
            ];

            for (let i = 0; i < sdkSources.length; i++) {
                try {
                    const sdkFunc = sdkSources[i]();
                    if (sdkFunc && typeof sdkFunc === 'function') {
                        log(`Found Monday SDK via method ${i + 1}`);
                        
                        const monday = sdkFunc();
                        const query = `
                            query {
                                boards(ids: [${boardId}]) {
                                    id
                                    name
                                    items {
                                        id
                                        name
                                        column_values {
                                            title
                                            text
                                            type
                                            value
                                        }
                                    }
                                }
                            }
                        `;
                        
                        const response = await monday.api(query);
                        log(`SDK API Response: ${JSON.stringify(response, null, 2)}`);
                        
                        if (response.data && response.data.boards && response.data.boards.length > 0) {
                            const board = response.data.boards[0];
                            log(`‚úÖ Board loaded via SDK: "${board.name}"`);
                            displayTasks(board);
                            return true;
                        }
                    }
                } catch (e) {
                    log(`SDK method ${i + 1} failed: ${e.message}`);
                }
            }
            
            throw new Error('Monday SDK not accessible');
        }

        // Display the actual tasks from Monday.com
        function displayTasks(board) {
            log(`Displaying ${board.items ? board.items.length : 0} tasks from board: ${board.name}`);
            
            const tasksSection = document.getElementById('tasksSection');
            const tasksSummary = document.getElementById('tasksSummary');
            const tasksTableBody = document.getElementById('tasksTableBody');
            
            // Update summary
            tasksSummary.textContent = `Loaded ${board.items ? board.items.length : 0} tasks from "${board.name}"`;
            
            // Clear loading state
            tasksTableBody.innerHTML = '';
            
            if (board.items && board.items.length > 0) {
                // Display each actual task
                board.items.forEach((item, index) => {
                    log(`Processing task ${index + 1}: "${item.name}" (ID: ${item.id})`);
                    
                    // Extract information from columns
                    let status = 'No status';
                    let timeline = 'No timeline';
                    let duration = 'No duration';
                    let assignee = 'Unassigned';
                    
                    if (item.column_values && item.column_values.length > 0) {
                        item.column_values.forEach(col => {
                            log(`  Column: ${col.title} (${col.type}) = ${col.text || col.value}`);
                            
                            if (col.type === 'status' && col.text) {
                                status = col.text;
                            } else if (col.type === 'timeline' && col.text) {
                                timeline = col.text;
                                // Try to extract duration from timeline
                                if (col.value) {
                                    try {
                                        const timelineData = JSON.parse(col.value);
                                        if (timelineData.from && timelineData.to) {
                                            const start = new Date(timelineData.from);
                                            const end = new Date(timelineData.to);
                                            const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                                            if (diffDays > 0) {
                                                duration = `${diffDays} days`;
                                            }
                                        }
                                    } catch (e) {
                                        log(`    Failed to parse timeline: ${e.message}`);
                                    }
                                }
                            } else if (col.type === 'numeric' && col.value && 
                                      (col.title.toLowerCase().includes('duration') || 
                                       col.title.toLowerCase().includes('days') ||
                                       col.title.toLowerCase().includes('estimate'))) {
                                duration = `${col.value} days`;
                            } else if (col.type === 'people' && col.text) {
                                assignee = col.text;
                            } else if (col.type === 'text' && col.text && 
                                      (col.title.toLowerCase().includes('duration') ||
                                       col.title.toLowerCase().includes('days'))) {
                                duration = col.text;
                            }
                        });
                    }
                    
                    // Create table row for this actual task
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="task-name">${item.name}</div>
                            <div class="task-id">ID: ${item.id}</div>
                        </td>
                        <td class="task-id">${item.id}</td>
                        <td>${status}</td>
                        <td>${timeline}</td>
                        <td><strong>${duration}</strong></td>
                        <td>${assignee}</td>
                    `;
                    
                    tasksTableBody.appendChild(row);
                });
                
                updateConnectionStatus(`‚úÖ Successfully loaded ${board.items.length} real tasks from your Monday.com board`, 'success');
            } else {
                tasksTableBody.innerHTML = `
                    <tr><td colspan="6" style="text-align: center; padding: 40px; color: #676879;">
                        No tasks found in this board. Try adding some tasks to your Monday.com board first.
                    </td></tr>
                `;
                updateConnectionStatus('‚ö†Ô∏è Board connected but no tasks found', 'warning');
            }
            
            // Show the tasks section
            tasksSection.style.display = 'block';
        }

        // Main function to load tasks
        async function loadTasks() {
            log('=== STARTING REAL TASK LOADING ===');
            
            const context = getMondayContext();
            
            if (!context.boardId) {
                updateConnectionStatus('‚ùå No board ID found - app not opened from a Monday.com board', 'error');
                return;
            }
            
            // Show board ID
            document.getElementById('boardIdDisplay').textContent = context.boardId;
            
            updateConnectionStatus('üîÑ Loading your actual Monday.com tasks...', 'warning');
            
            // Try multiple methods to get real task data
            let success = false;
            
            // Method 1: Try Monday SDK
            if (!success) {
                try {
                    log('Trying Method 1: Monday SDK');
                    await loadTasksWithSDK(context.boardId);
                    success = true;
                } catch (error) {
                    log(`Method 1 failed: ${error.message}`);
                }
            }
            
            // Method 2: Try direct API with session token
            if (!success && context.sessionToken) {
                try {
                    log('Trying Method 2: Direct API with session token');
                    await loadTasksWithToken(context.boardId, context.sessionToken);
                    success = true;
                } catch (error) {
                    log(`Method 2 failed: ${error.message}`);
                }
            }
            
            if (!success) {
                updateConnectionStatus('‚ùå Could not load tasks - Monday.com API not accessible from this environment', 'error');
                log('All methods failed to load real tasks');
                
                // Show helpful message
                document.getElementById('tasksSection').style.display = 'block';
                document.getElementById('tasksSummary').textContent = 'Unable to load tasks - API access limitations';
                document.getElementById('tasksTableBody').innerHTML = `
                    <tr><td colspan="6" style="padding: 20px; text-align: center;">
                        <div style="color: #e2445c; font-weight: 600;">‚ö†Ô∏è Cannot Access Monday.com API</div>
                        <div style="margin-top: 8px; color: #676879; font-size: 13px;">
                            Your app is connected (Board ID: ${context.boardId}) but cannot retrieve task data due to API restrictions in this environment.
                            <br><br>
                            <strong>To see your real tasks:</strong><br>
                            ‚Ä¢ The app needs to be properly published in Monday.com<br>
                            ‚Ä¢ Or use Monday.com's hosting environment<br>
                            ‚Ä¢ Current environment has cross-origin restrictions
                        </div>
                    </td></tr>
                `;
            }
        }

        // Test API connectivity
        async function testAPI() {
            log('=== API CONNECTIVITY TEST ===');
            const context = getMondayContext();
            
            if (context.sessionToken) {
                try {
                    const response = await fetch('https://api.monday.com/v2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${context.sessionToken}`,
                        },
                        body: JSON.stringify({
                            query: '{ me { name email } }'
                        })
                    });
                    
                    log(`API Test Response Status: ${response.status}`);
                    const data = await response.json();
                    log(`API Test Response: ${JSON.stringify(data, null, 2)}`);
                    
                } catch (error) {
                    log(`API Test Error: ${error.message}`);
                }
            } else {
                log('No session token available for API test');
            }
        }

        // Initialize the app
        function initialize() {
            log('Monday.com Tasks App - Starting...');
            log(`Current URL: ${window.location.href}`);
            log(`Running in iframe: ${window !== window.top}`);
            
            const context = getMondayContext();
            if (context.boardId) {
                document.getElementById('boardIdDisplay').textContent = context.boardId;
                updateConnectionStatus(`‚úÖ Connected to Monday.com Board: ${context.boardId}`, 'success');
                
                // Automatically try to load tasks
                setTimeout(() => {
                    loadTasks();
                }, 1000);
            } else {
                updateConnectionStatus('‚ùå No Monday.com board context detected', 'error');
            }
        }

        // Start when page loads
        window.addEventListener('load', function() {
            setTimeout(initialize, 500);
        });
    </script>
</body>
</html>
