<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Monday Test</title>
    <script src="https://dapulse-res.cloudinary.com/image/upload/remote_logos/995333-ec8cea4e1cbd2bd50c4bb5e24c83df0b.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .status-box { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; border: 1px solid #ddd; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        button { background: #0073ea; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin: 5px; cursor: pointer; }
        button:hover { background: #005bb5; }
        .debug-log { background: #000; color: #00ff00; padding: 15px; font-family: monospace; font-size: 12px; height: 300px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Minimal Monday.com Connection Test</h1>
        
        <div class="status-box">
            <h2>Connection Status</h2>
            <div id="status">Starting tests...</div>
        </div>

        <div class="status-box">
            <h2>Board Data</h2>
            <div id="boardData">Waiting for connection...</div>
        </div>

        <div class="status-box">
            <h2>Actions</h2>
            <button onclick="runTest()">üîÑ Run Test</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="status-box">
            <h2>Debug Log</h2>
            <div id="debugLog" class="debug-log">Initializing...\n</div>
        </div>
    </div>

    <script>
        let monday = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('debugLog');
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[Monday Test] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<span class="${type}">${message}</span>`;
            log(message, type);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = 'Log cleared.\n';
        }

        async function runTest() {
            log('=== STARTING MONDAY.COM CONNECTION TEST ===');
            
            try {
                // Test 1: Environment Check
                log('Test 1: Environment Detection');
                log(`URL: ${window.location.href}`);
                log(`In iframe: ${window !== window.top}`);
                log(`Referrer: ${document.referrer}`);
                updateStatus('Environment detected', 'info');

                // Test 2: SDK Check
                log('Test 2: Monday SDK Check');
                if (typeof mondaySDK === 'undefined') {
                    log('Monday SDK not found', 'error');
                    updateStatus('‚ùå Monday SDK not available', 'error');
                    
                    // Try to load it
                    log('Attempting to load SDK...');
                    await loadSDK();
                } else {
                    log('Monday SDK found!', 'success');
                    updateStatus('‚úÖ Monday SDK available', 'success');
                }

                // Test 3: Initialize SDK
                log('Test 3: Initialize Monday SDK');
                if (typeof mondaySDK !== 'undefined') {
                    monday = mondaySDK();
                    log('SDK initialized successfully', 'success');
                    updateStatus('‚úÖ SDK initialized', 'success');

                    // Test 4: Get Context
                    log('Test 4: Getting context...');
                    try {
                        const context = await monday.get("context");
                        log(`Context: ${JSON.stringify(context, null, 2)}`, 'success');
                        
                        if (context && context.data && context.data.boardId) {
                            updateStatus(`‚úÖ Connected to board: ${context.data.boardId}`, 'success');
                            
                            // Test 5: Get Board Data
                            log('Test 5: Getting board data...');
                            await getBoardData(context.data.boardId);
                        } else {
                            updateStatus('‚ö†Ô∏è No board context available', 'warning');
                            log('No board ID in context - app may not be opened from a board', 'warning');
                        }
                    } catch (error) {
                        log(`Context error: ${error.message}`, 'error');
                        updateStatus(`‚ùå Context failed: ${error.message}`, 'error');
                    }
                } else {
                    updateStatus('‚ùå SDK still not available', 'error');
                }

                log('=== TEST COMPLETED ===');

            } catch (error) {
                log(`Test failed: ${error.message}`, 'error');
                updateStatus(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }

        function loadSDK() {
            return new Promise((resolve, reject) => {
                log('Loading Monday SDK script...');
                const script = document.createElement('script');
                script.src = 'https://dapulse-res.cloudinary.com/image/upload/remote_logos/995333-ec8cea4e1cbd2bd50c4bb5e24c83df0b.js';
                script.onload = () => {
                    log('SDK script loaded');
                    setTimeout(() => {
                        if (typeof mondaySDK !== 'undefined') {
                            log('Monday SDK now available!', 'success');
                            resolve(true);
                        } else {
                            log('SDK still not available after load', 'error');
                            reject(new Error('SDK not available after load'));
                        }
                    }, 1000);
                };
                script.onerror = () => {
                    log('Failed to load SDK script', 'error');
                    reject(new Error('SDK script load failed'));
                };
                document.head.appendChild(script);
            });
        }

        async function getBoardData(boardId) {
            try {
                const query = `
                    query {
                        boards(ids: [${boardId}]) {
                            id
                            name
                            items_count
                            items {
                                id
                                name
                                column_values {
                                    title
                                    text
                                    type
                                }
                            }
                        }
                    }
                `;

                log('Sending GraphQL query...');
                const response = await monday.api(query);
                log(`API Response: ${JSON.stringify(response, null, 2)}`, 'success');

                if (response.data && response.data.boards && response.data.boards.length > 0) {
                    const board = response.data.boards[0];
                    log(`Successfully loaded board: ${board.name}`, 'success');
                    
                    document.getElementById('boardData').innerHTML = `
                        <div class="success">‚úÖ Board: ${board.name}</div>
                        <div>ID: ${board.id}</div>
                        <div>Items: ${board.items_count}</div>
                        <div>Tasks loaded: ${board.items.length}</div>
                    `;

                    updateStatus(`‚úÖ Board loaded: ${board.name} (${board.items.length} items)`, 'success');
                } else {
                    log('No board data received', 'error');
                    updateStatus('‚ùå No board data received', 'error');
                }

            } catch (error) {
                log(`Board data error: ${error.message}`, 'error');
                updateStatus(`‚ùå Board data failed: ${error.message}`, 'error');
            }
        }

        // Auto-run test when page loads
        window.addEventListener('load', function() {
            log('Page loaded, waiting 2 seconds then running test...');
            setTimeout(runTest, 2000);
        });
    </script>
</body>
</html>
